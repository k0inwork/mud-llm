# Phase 4 Design: Sentient Entities & Action Significance

## 1. Objectives

With the core AI infrastructure in place, this phase focuses on enabling dynamic, intelligent behavior for NPCs and Owners. A critical objective is to implement the "Action Significance" model to efficiently manage when and how LLMs are prompted, preventing unnecessary API calls while ensuring AI entities react appropriately to meaningful player actions.

## 2. Key Components to be Implemented

### 2.1. Action Significance Monitor

This new module will sit between the Core Game Engine and the LLM Integration Module. Its purpose is to filter and batch player actions, ensuring that LLM calls are only triggered for events deemed significant by the game design.

*   **Action Logging:** The Core Game Engine will be modified to log all player actions (e.g., `move`, `attack`, `talk`, `use item`) to a temporary, per-player, per-entity (NPC/Owner) action buffer. Each logged action will include its type, relevant parameters, and a timestamp.
*   **Significance Scoring:** Each player action type will have a predefined "significance score." This score will be configurable (e.g., in the database via the web editor from Phase 1). For example:
    *   `move`: Low significance (e.g., 1 point)
    *   `look`: Low significance (e.g., 0 points)
    *   `talk`: Medium significance (e.g., 5 points)
    *   `attack`: High significance (e.g., 10 points)
    *   `pray`: High significance (e.g., 10 points)
*   **Threshold-Based Triggering:**
    *   For each NPC and Owner, a "reaction threshold" will be defined (also configurable via the web editor).
    *   The Action Significance Monitor will continuously sum the significance scores of actions in a player's buffer that are relevant to a specific NPC/Owner (e.g., actions in the same room for an NPC, or actions related to a monitored aspect for an Owner).
    *   When the cumulative score for an NPC/Owner exceeds its threshold, an LLM prompt is triggered for that entity.
*   **Action Batching:** When an LLM prompt is triggered, all relevant batched actions from the player's buffer (since the last reaction for that specific NPC/Owner) will be included in the prompt context. This allows the LLM to react to a sequence of events rather than just the last one. The buffer for that NPC/Owner will then be cleared.

### 2.2. Sentient Entity Manager (Enhanced)

This manager will orchestrate AI responses based on the Action Significance Monitor.

*   **Event Subscription:** The Sentient Entity Manager will subscribe to "significant action" events generated by the Action Significance Monitor.
*   **Prompt Initiation:** When a significant action event is received for an NPC or Owner, the manager will:
    1.  Retrieve the relevant batched actions from the Action Significance Monitor for the specific player and entity.
    2.  Call the Prompt Assembler (from Phase 3) to construct the LLM prompt. This prompt will include the batched actions as part of the dynamic context, allowing the LLM to understand the sequence of events leading to its activation.
    3.  Send the constructed prompt to the LLM API Client.
*   **Response Handling:**
    1.  Receive the LLM response (containing narrative and potential tool calls).
    2.  Send the narrative part to the Server-Side Presentation Layer for display to the player.
    3.  Send any tool calls to the Tool Dispatcher for execution.

### 2.3. Integrating AI Responses

*   The `HandleLLMResponse` function will be refined to ensure seamless integration of LLM-generated narrative and tool calls into the game flow.
*   Narrative will be converted to semantic JSON and sent to the presentation layer.
*   Tool calls will be executed by the Tool Dispatcher, potentially modifying game state or triggering further events.

## 3. Acceptance Criteria

1.  Player actions are correctly logged and assigned significance scores.
2.  NPCs and Owners only trigger LLM interactions when their configurable significance threshold is met by relevant player actions.
3.  When an LLM interaction is triggered, the LLM receives a batch of all relevant player actions that accumulated since its last reaction.
4.  NPCs and Owners react dynamically and contextually to these batched player actions (e.g., an NPC in a room reacts to a player `say` command, an Owner reacts to a `pray` command or a significant action in its monitored domain).
5.  All AI-generated narrative is correctly formatted and displayed to the player via the server-side presentation layer.
6.  The system demonstrates efficient LLM usage, avoiding unnecessary API calls for trivial player actions, and the Action Significance Monitor effectively filters and batches events.
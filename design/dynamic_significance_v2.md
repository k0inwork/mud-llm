# **Design: Dynamic Action Significance System (V2.0)**

**Author:** Gemini
**Status:** Proposed
**Version:** 2.0

---

## 1. Overview

This document outlines the architecture for a dynamic action significance system for GoMUD. The primary goal is to create a world where non-player entities (NPCs, Owners, Questmakers, etc.) react to player actions in a way that is believable, nuanced, and emergent. This system moves beyond static, hardcoded action scores to a context-aware model based on entity perception.

## 2. Core Philosophy: Perception is Reality

The fundamental principle of this system is that an entity's reaction is based not on the objective ground truth of what happened, but on **what they perceive to have happened.**

This distinction is the cornerstone of believable AI. A commoner who sees a player character enveloped in magical energy should react with fear or awe; a master mage who recognizes the specific somatic components of a forbidden spell should react with alarm and hostility. The system must model this subjective perception to create an immersive experience.

## 3. High-Level Architecture: An Event-Driven, Two-Speed System

To ensure both immediate responsiveness and long-term world coherence without sacrificing performance, the architecture is built on an **asynchronous, in-game event bus**. This creates a two-speed model for processing information:

1.  **Synchronous, Local Processing:** Handles immediate reactions for entities in the same location as the action. This is executed in real-time to provide instant feedback (e.g., a guard shouting when they see a crime).
2.  **Asynchronous, Global Propagation:** Handles the "ripple effect" of actions for non-local observers (e.g., a faction leader hearing about their agent's deeds). This is handled by background workers processing events from the bus, ensuring the main game loop remains fast.

![Architecture Diagram](https://i.imgur.com/example_diagram.png)  
*(Note: A diagram would be inserted here in a real document to illustrate the flow from Action -> Event Bus -> Local/Global Processors.)*

## 4. Key Data Structures

### 4.1. The `ActionEvent`

This struct represents the objective **ground truth** of a player's action. It is created by the command handler and is the central data packet that the entire system processes.

```go
// internal/game/events/action_event.go

// ActionEvent represents the ground truth of a player's action.
type ActionEvent struct {
    Player      *models.Player
    ActionType  string        // The canonical action type, e.g., "use_skill", "say".
    SkillUsed   *models.Skill // A reference to the skill model, if applicable.
    Targets     []interface{} // A slice of entities (NPCs, Items, etc.) to support AoE.
    Room        *models.Room
    Timestamp   time.Time
    // Other relevant metadata, e.g., text for a "say" command.
}
```

### 4.2. The `PerceivedAction`

This struct represents an observer's **subjective interpretation** of an `ActionEvent`. It is generated by passing an `ActionEvent` through an observer's "Perception Filter."

```go
// internal/game/perception/perceived_action.go

// PerceivedAction represents an entity's subjective interpretation of an event.
type PerceivedAction struct {
    Observer            interface{} // The entity doing the perceiving.
    SourcePlayer        *models.Player
    Target              interface{} // The specific target of this perception.
    PerceivedActionType string      // e.g., "tamper_lock", "cast_hostile_spell", "attack_ally".
    Clarity             float64     // 0.0 (not understood) to 1.0 (perfectly understood).
    ApparentSkillLevel  int         // How expertly the observer thinks the action was performed (1-100).
    IsCriminal          bool        // Was the act perceived as illegal according to the observer's laws/morals?
    Timestamp           time.Time
}
```

## 5. The Significance Pipeline

A player action is processed through a five-step pipeline to determine the reaction of every relevant entity.

**Step 1: Event Creation**
A player executes a command. The `TelnetServer`'s command handler validates the action and creates a single, comprehensive `ActionEvent` struct, populating it with the ground truth.

**Step 2: Local Observation**
The `ActionSignificanceMonitor` receives the `ActionEvent`. It identifies all entities present in the same room (the "local observers").

**Step 3: Perception Filtering**
For each local observer, the system applies a **Perception Filter**. This crucial step translates the objective `ActionEvent` into a subjective `PerceivedAction`. This is detailed further in Section 7.

**Step 4: Significance Calculation**
The resulting `PerceivedAction` is fed into the scoring logic for the observer. To ensure stability and ease of tuning, the formula is a hybrid additive/multiplicative model:

`Final Score = (BaseScore + Î£ AdditiveBonuses) * Multiplier * Clarity`

*   **Base Score:** A value determined by the `PerceivedActionType`.
*   **Additive Bonuses:** A sum of simple point adjustments from various contexts.
*   **Multipliers:** Reserved for a few, powerful effects.
*   **Clarity:** The `Clarity` score from the `PerceivedAction` acts as a final multiplier, ensuring that poorly understood actions have proportionally less significance.

**Step 5: Reaction Trigger & Asynchronous Propagation**
The calculated score is added to the observer's cumulative significance buffer for that player. If the total exceeds the entity's `ReactionThreshold`, a reaction is triggered via the `SentientEntityManager`.

Finally, regardless of local reactions, the original `ActionEvent` is published to the global event bus for asynchronous processing by non-local entities.

## 6. Solving Critical Design Challenges

This architecture is designed to preemptively solve key challenges:

*   **The `Fireball` Dilemma (AoE):** The `ActionEvent.Targets` slice allows a single action to have multiple targets.
*   **The `Chain Reaction` Spiral (Performance):** Entities enter a "reaction cooldown" after reacting to prevent spam.
*   **The `Invisible Observer` (Scalability):** The event bus decouples local and global observers for better performance.
*   **The `Tuning Nightmare` (Balance):** The additive-first scoring model is more stable and predictable.

## 7. Deep Dive: The Perception Filter

The Perception Filter is not a single function, but a layered system of checks and modifiers that determines how an `ActionEvent` is translated into a `PerceivedAction`. The core output of this filter is the **Clarity** score (from 0.0 to 1.0), which dictates how well the action was understood. This score then directly influences the `PerceivedActionType`.

### 7.1. Layer 0: Physical Sensory Check

This is a hard gate for any perception.
*   **Line of Sight:** Is there a physical obstruction? If yes, perception fails.
*   **Sensory State:** Is the observer blind, deaf, or unconscious? If the action is purely visual (e.g., a gesture) and the observer is blind, perception fails.
*   **Distance:** Is the action too far away to be perceived clearly? Clarity is reduced based on distance.

### 7.2. Layer 1: Innate & Cultural Bias (The Base Clarity)

This layer establishes the starting `Clarity` based on the observer's inherent nature and the environment's culture. These biases are defined in data (e.g., `races.json`, `territories.json`).

*   **Racial Bias:** Determines the default understanding of broad action categories.
    *   *Example:* An Orc sees a player use a magic spell. Orcs are racially distrustful of magic. The `ActionEvent`'s `ActionType` is "use_skill" and the skill's category is "magic". The Orc's racial bias sets the initial `Clarity` to `0.3` (poor understanding) and the `PerceivedActionType` to "bad_magic".
    *   *Example:* An Elf sees the same spell. Elves are racially attuned to magic. The initial `Clarity` is `0.8` (good understanding) and the `PerceivedActionType` is "arcane_weaving".
*   **Territorial Bias:** The culture of the current location can override or modify racial bias.
    *   *Example:* The aforementioned Orc is in the "Magic Quarter" of a cosmopolitan city, where magic is commonplace. The territorial bias adds `+0.2` to `Clarity`, raising the Orc's understanding to `0.5`. They still don't like it, but they are used to it.

### 7.3. Layer 2: Knowledge & Experience (Clarity Refinement)

This layer refines `Clarity` based on the observer's personal experience and training.

*   **Profession & Class:** An observer's profession or class grants deeper understanding of related actions.
    *   *Example:* A player, a Rogue, uses the "Disable Trap" skill. A Barbarian observer (hates subterfuge) might have their `Clarity` reduced by `-0.1`. A fellow Rogue observer, however, would have their `Clarity` increased by `+0.4`, allowing them to perfectly understand the action (`Clarity` capped at 1.0).
*   **Skill Proficiency:** The observer's own skill level matters. A Master Mage observing a novice's `Fireball` will have perfect `Clarity` (1.0) and a high `ApparentSkillLevel` perception. They see it for exactly what it is.

### 7.4. Layer 3: Explicit Modifiers (Passive Skills & Buffs)

This is the final layer, where specific game mechanics grant explicit perception bonuses or penalties. These are represented by passive skills or status effects on the observer.

*   **Perception-enhancing Skills:**
    *   *`[Passive Skill] Arcane Attunement`*: Grants `+0.3 Clarity` when observing any magic-based skill.
    *   *`[Passive Skill] Urban Awareness`*: Grants `+0.2 Clarity` for social and subterfuge skills used within a city territory.
*   **Perception-reducing Effects:**
    *   *`[Debuff] Confused`*: Applies a `-0.5 Clarity` penalty to all observations.
    *   *`[Racial Trait] Arrogance`*: A Barbarian might have this trait, giving `-0.1 Clarity` to any action performed by someone they perceive as physically weaker.

### 7.5. Final Output

After passing through these layers, the final `Clarity` score is set. This score then determines the final `PerceivedActionType`.
*   If `Clarity` > 0.9, the observer understands the action perfectly. `PerceivedActionType` might be the skill's actual name (e.g., "Lesser Heal").
*   If 0.5 < `Clarity` < 0.9, the observer gets the gist. `PerceivedActionType` is a category (e.g., "healing_magic").
*   If `Clarity` < 0.5, the observer is mostly confused. `PerceivedActionType` is vague and potentially wrong (e.g., "strange_glow").

This layered model for perception provides a rich, data-driven foundation for creating truly subjective and intelligent entity reactions.

## 8. Conclusion

The V2 Dynamic Significance System provides a robust, scalable, and immersive framework for intelligent entity reactions. By prioritizing perception and employing a modern event-driven architecture, it lays the foundation for a truly dynamic and believable world.